#!/usr/bin/env zsh

# Created by Zap installer
[ -f "${XDG_DATA_HOME:-${ZDOTDIR}/.local/share}/zap/zap.zsh" ] && source "${XDG_DATA_HOME:-$HOME/.local/share}/zap/zap.zsh"

# Load and initialise brew-provided completions
if type brew &>/dev/null
then
  FPATH="$(brew --prefix)/share/zsh/site-functions:${FPATH}"
fi
autoload -Uz compinit
compinit

# Source ancillary files
source <(fzf --zsh)
source "${ZDOTDIR}/aliases.zsh"
source "${ZDOTDIR}/functions.zsh"
source "${ZDOTDIR}/keys.zsh"
source "${ZDOTDIR}/cmp-sources/cmp-glow.zsh"
source "${ZDOTDIR}/cmp-sources/cmp-fzf.zsh"
source "${ZDOTDIR}/cmp-sources/cmp-chez.zsh"
source "${ZDOTDIR}/cmp-sources/_atuin"
test -e "${ZDOTDIR}/.iterm2_shell_integration.zsh" && source "${ZDOTDIR}/.iterm2_shell_integration.zsh"

# init CLI tools
. "$HOME/.atuin/bin/env"
eval "$(atuin init zsh --disable-up-arrow)"
eval "$(pyenv init -)"
eval "$(starship init zsh)"
eval "$(zoxide init zsh)"
if which rbenv > /dev/null; then eval "$(rbenv init -)"; fi

# plugins
plug "aloxaf/fzf-tab"
plug "freed-wu/fzf-tab-source"
plug "zsh-users/zsh-autosuggestions"
plug "zsh-users/zsh-syntax-highlighting"
plug "zsh-users/zsh-history-substring-search"
plug "ael-code/zsh-colored-man-pages"

# Directory history
setopt AUTO_PUSHD                  # pushes the old directory onto the stack
setopt PUSHD_MINUS                 # exchange the meanings of '+' and '-'
setopt CDABLE_VARS                 # expand the expression (allows 'cd -2/tmp')
setopt extended_glob

# fzf-tab
zstyle ':completion:*:directory-stack' list-colors '=(#b) #([0-9]#)*( *)==95=38;5;12'
zstyle ':fzf-tab:*' fzf-command fzf
zstyle ':completion:*:git-checkout:*' sort false
zstyle ':completion:*:descriptions' format '[%d]'
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
zstyle ':completion:*' menu no
zstyle ':fzf-tab:*' switch-group '<' '>'
zstyle ':fzf-tab:*' popup-min-size 80 40
zstyle ':fzf-tab:complete:*:*' fzf-preview 'less ${(Q)realpath}'

# for the odd project with intel only dependencies
if [[ $(arch) == arm64 ]]; then
    export PATH="/$HOME/.pyenv/shims:$PATH"
    export PYENV_ROOT="$HOME/.pyenv"
else
    export PATH="/$HOME/.pyenv-i386/shims:$PATH"
    export PYENV_ROOT="$HOME/.pyenv-i386"
fi
[[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"

# Environment variables
export BAT_THEME="ansi"
export DYLD_LIBRARY_PATH="$(brew --prefix)/lib:$DYLD_LIBRARY_PATH"
export DYLD_FALLBACK_LIBRARY_PATH="$(brew --prefix)/lib:$DYLD_FALLBACK_LIBRARY_PATH"
export MANPAGER="nvimpager -p"
export MOZ_DISABLE_SAFE_MODE_KEY=1
export STARSHIP_LOG=error
export CLIPBOARD_THEME=ansi
export EZA_GRID_ROWS=10
export LESS='-R'  # interpret color characters
export LESSOPEN="|/opt/homebrew/bin/lesspipe.sh %s"
# export LESSCOLORIZER="nvimpager"
export PATH="$HOME/go/bin:$PATH"
